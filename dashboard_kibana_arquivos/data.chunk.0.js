(window.data_bundle_jsonpfunction=window.data_bundle_jsonpfunction||[]).push([[0],{119:function(e,t,s){"use strict";s.r(t),s.d(t,"default",(function(){return query_string_input_QueryStringInputUI}));var i=s(50),n=s.n(i),a=s(3),r=s.n(a),o=s(4),u=s.n(o),l=s(0),h=s(107),c=s.n(h),g=s(13),p=s(16),d=s(1),y=s(25),m=s(55),b=s(28);function f({language:e,anchorPosition:t,onSelectLanguage:s,nonKqlMode:i="lucene",nonKqlModeHelpText:n}){const a=Object(b.useKibana)().services.docLinks.links.query.kueryQuerySyntax,[r,h]=Object(o.useState)(!1),c=u.a.createElement(p.FormattedMessage,{id:"data.query.queryBar.luceneLanguageName",defaultMessage:"Lucene"}),d=u.a.createElement(p.FormattedMessage,{id:"data.query.queryBar.kqlLanguageName",defaultMessage:"KQL"}),y=u.a.createElement(p.FormattedMessage,{id:"data.query.queryBar.kqlFullLanguageName",defaultMessage:"Kibana Query Language"}),m=l.i18n.translate("data.query.queryBar.languageSwitcher.toText",{defaultMessage:"Switch to Kibana Query Language for search"}),f=u.a.createElement(g.EuiButtonEmpty,{size:"xs",onClick:()=>h(!r),className:"euiFormControlLayout__append kqlQueryBar__languageSwitcherButton","data-test-subj":"switchQueryLanguageButton"},"kuery"===e?d:"lucene"===i?c:u.a.createElement(g.EuiIcon,{type:"boxesVertical",title:m,"aria-label":m}));return u.a.createElement(g.EuiPopover,{id:"queryLanguageSwitcherPopover",anchorClassName:"euiFormControlLayout__append",anchorPosition:t||"downRight",button:f,isOpen:r,closePopover:()=>h(!1),repositionOnScroll:!0,ownFocus:!0,initialFocus:'[role="switch"]'},u.a.createElement(g.EuiPopoverTitle,null,u.a.createElement(p.FormattedMessage,{id:"data.query.queryBar.syntaxOptionsTitle",defaultMessage:"Syntax options"})),u.a.createElement("div",{style:{width:"350px"}},u.a.createElement(g.EuiText,{size:"s"},u.a.createElement("p",null,u.a.createElement(p.FormattedMessage,{id:"data.query.queryBar.syntaxOptionsDescription",defaultMessage:"The {docsLink} (KQL) offers a simplified query syntax and support for scripted fields. KQL also provides autocomplete. If you turn off KQL, {nonKqlModeHelpText}",values:{docsLink:u.a.createElement(g.EuiLink,{href:a,target:"_blank"},y),nonKqlModeHelpText:n||l.i18n.translate("data.query.queryBar.syntaxOptionsDescription.nonKqlModeHelpText",{defaultMessage:"Kibana uses Lucene."})}}))),u.a.createElement(g.EuiSpacer,{size:"m"}),u.a.createElement(g.EuiForm,null,u.a.createElement(g.EuiFormRow,{label:y},u.a.createElement(g.EuiSwitch,{id:"queryEnhancementOptIn",name:"popswitch",label:"kuery"===e?u.a.createElement(p.FormattedMessage,{id:"data.query.queryBar.kqlOnLabel",defaultMessage:"On"}):u.a.createElement(p.FormattedMessage,{id:"data.query.queryBar.kqlOffLabel",defaultMessage:"Off"}),checked:"kuery"===e,onChange:()=>{s("kuery"===e?i:"kuery")},"data-test-subj":"languageToggle"})))))}var S=s(20),E=s(32),q=s(2);const x={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,ESC:27,TAB:9,HOME:36,END:35};class query_string_input_QueryStringInputUI extends o.Component{constructor(...e){var t;super(...e),r()(this,"state",{isSuggestionsVisible:!1,index:null,suggestions:[],suggestionLimit:50,selectionStart:null,selectionEnd:null,indexPatterns:[],queryBarRect:void 0}),r()(this,"inputRef",null),r()(this,"persistedLog",void 0),r()(this,"abortController",void 0),r()(this,"fetchIndexPatternsAbortController",void 0),r()(this,"services",this.props.kibana.services),r()(this,"reportUiCounter",null===(t=this.services.usageCollection)||void 0===t?void 0:t.reportUiCounter.bind(this.services.usageCollection,this.services.appName)),r()(this,"componentIsUnmounting",!1),r()(this,"queryBarInputDivRefInstance",Object(o.createRef)()),r()(this,"isFocusWithin",!1),r()(this,"getQueryString",(()=>Object(S.s)(this.props.query.query))),r()(this,"fetchIndexPatterns",Object(d.debounce)((async()=>{const e=this.props.indexPatterns.filter((e=>"string"==typeof e)),t=this.props.indexPatterns.filter((e=>"string"!=typeof e));this.fetchIndexPatternsAbortController&&this.fetchIndexPatternsAbortController.abort(),this.fetchIndexPatternsAbortController=new AbortController;const s=this.fetchIndexPatternsAbortController,i=await async function(e,t){if(!t||Object(d.isEmpty)(t))return[];const s=t.map((e=>`"${e}"`)).join(" | "),i=(await e.find(s)).filter((e=>t.includes(e.title)));return i.length===t.length?i:[...i,await e.getDefault()]}(this.services.data.indexPatterns,e);s.signal.aborted||(this.setState({indexPatterns:[...t,...i]}),this.updateSuggestions())}),200)),r()(this,"getSuggestions",(async()=>{if(!this.inputRef)return;const e=this.props.query.language,t=this.getQueryString(),s=this.getRecentSearchSuggestions(t);if(!this.services.data.autocomplete.hasQuerySuggestions(e)||!Array.isArray(this.state.indexPatterns)||0===Object(d.compact)(this.state.indexPatterns).length)return s;const i=this.state.indexPatterns,{selectionStart:n,selectionEnd:a}=this.inputRef;if(null!==n&&null!==a)try{this.abortController&&this.abortController.abort(),this.abortController=new AbortController;return[...await this.services.data.autocomplete.getQuerySuggestions({language:e,indexPatterns:i,query:t,selectionStart:n,selectionEnd:a,signal:this.abortController.signal,useTimeRange:this.props.timeRangeForSuggestionsOverride})||[],...s]}catch(e){var r;if("The user aborted a request."===e.message)return;throw null===(r=this.reportUiCounter)||void 0===r||r.call(this,y.METRIC_TYPE.LOADED,"query_string:suggestions_error"),e}})),r()(this,"getRecentSearchSuggestions",(e=>{if(!this.persistedLog)return[];return this.persistedLog.get().filter((t=>{const s="object"==typeof t?Object(S.s)(t):t;return""!==s&&s.includes(e)})).map((t=>{const s=Object(S.s)(t),i=e.length;return{type:m.b.RecentSearch,text:s,start:0,end:i}}))})),r()(this,"updateSuggestions",Object(d.debounce)((async()=>{const e=await this.getSuggestions()||[];this.componentIsUnmounting||this.setState({suggestions:e})}),100)),r()(this,"onSubmit",(e=>{this.props.onSubmit&&(this.persistedLog&&this.persistedLog.add(e.query),this.props.onSubmit({query:Object(S.j)(e.query),language:e.language}))})),r()(this,"onChange",(e=>{this.updateSuggestions(),this.props.onChange&&this.props.onChange({query:Object(S.j)(e.query),language:e.language})})),r()(this,"onQueryStringChange",(e=>{this.setState({isSuggestionsVisible:!0,index:null,suggestionLimit:50}),this.onChange({query:e,language:this.props.query.language})})),r()(this,"onInputChange",(e=>{const t=this.formatTextAreaValue(e.target.value);this.onQueryStringChange(t),""===e.target.value?this.handleRemoveHeight():this.handleAutoHeight()})),r()(this,"onClickInput",(e=>{if(e.target instanceof HTMLTextAreaElement){const t=this.formatTextAreaValue(e.target.value);this.onQueryStringChange(t)}})),r()(this,"onKeyUp",(e=>{if([x.LEFT,x.RIGHT,x.HOME,x.END].includes(e.keyCode)&&(this.setState({isSuggestionsVisible:!0}),e.target instanceof HTMLTextAreaElement)){const t=this.formatTextAreaValue(e.target.value);this.onQueryStringChange(t)}})),r()(this,"onKeyDown",(e=>{if(e.target instanceof HTMLTextAreaElement){const{isSuggestionsVisible:t,index:s}=this.state,i=e.preventDefault.bind(e),{target:n,key:a,metaKey:r}=e,{value:o,selectionStart:u,selectionEnd:l}=n,h=(e,t,s)=>{this.onQueryStringChange(e),this.setState({selectionStart:t,selectionEnd:s})};switch(e.keyCode){case x.DOWN:t&&null!==s?(e.preventDefault(),this.incrementIndex(s)):(t&&null==s||""===this.getQueryString())&&(e.preventDefault(),this.setState({isSuggestionsVisible:!0,index:0}));break;case x.UP:t&&null!==s&&(e.preventDefault(),this.decrementIndex(s));break;case x.ENTER:this.props.bubbleSubmitEvent||e.preventDefault(),t&&null!==s&&this.state.suggestions[s]?(e.preventDefault(),this.selectSuggestion(this.state.suggestions[s],s)):(this.onSubmit(this.props.query),this.setState({isSuggestionsVisible:!1}));break;case x.ESC:e.preventDefault(),this.setState({isSuggestionsVisible:!1,index:null});break;case x.TAB:this.setState({isSuggestionsVisible:!1,index:null});break;default:null!==u&&null!==l&&Object(S.q)({value:o,selectionStart:u,selectionEnd:l,key:a,metaKey:r,updateQuery:h,preventDefault:i})}}})),r()(this,"selectSuggestion",((e,t)=>{var s,i;if(!this.inputRef)return;const{type:n,text:a,start:r,end:o,cursorIndex:u}=e;this.handleNestedFieldSyntaxNotification(e);const l=this.getQueryString(),{selectionStart:h,selectionEnd:c}=this.inputRef;if(null===h||null===c)return;const g=l.substr(0,h)+l.substr(c),p=g.substr(0,r)+a+g.substr(o);null===(s=this.reportUiCounter)||void 0===s||s.call(this,y.METRIC_TYPE.CLICK,`query_string:${n}:suggestions_select_position_${t}`),null===(i=this.reportUiCounter)||void 0===i||i.call(this,y.METRIC_TYPE.CLICK,`query_string:${n}:suggestions_select_q_length_${o-r}`),this.onQueryStringChange(p),this.setState({selectionStart:r+(u||a.length),selectionEnd:r+(u||a.length)});const d=n===m.b.RecentSearch,b=this.props.autoSubmit&&(n===m.b.Value||[":*",": *"].includes(g.trim()));(d||b)&&(this.setState({isSuggestionsVisible:!1,index:null}),this.onSubmit({query:p,language:this.props.query.language}))})),r()(this,"handleNestedFieldSyntaxNotification",(e=>{const t="field"in e&&Object(q.getFieldSubtypeNested)(e.field);if(t&&t.nested&&!this.services.storage.get("kibana.KQLNestedQuerySyntaxInfoOptOut")){const{notifications:e,docLinks:t}=this.services,s=t=>{this.services.storage&&(this.services.storage.set("kibana.KQLNestedQuerySyntaxInfoOptOut",!0),e.toasts.remove(t))};if(e&&t){const i=e.toasts.add({title:l.i18n.translate("data.query.queryBar.KQLNestedQuerySyntaxInfoTitle",{defaultMessage:"KQL nested query syntax"}),text:Object(b.toMountPoint)(u.a.createElement("div",null,u.a.createElement("p",null,u.a.createElement(p.FormattedMessage,{id:"data.query.queryBar.KQLNestedQuerySyntaxInfoText",defaultMessage:"It looks like you're querying on a nested field. You can construct KQL syntax for nested queries in different ways, depending on the results you want. Learn more in our {link}.",values:{link:u.a.createElement(g.EuiLink,{href:t.links.query.kueryQuerySyntax,target:"_blank"},u.a.createElement(p.FormattedMessage,{id:"data.query.queryBar.KQLNestedQuerySyntaxInfoDocLinkText",defaultMessage:"docs"}))}})),u.a.createElement(g.EuiFlexGroup,{justifyContent:"flexEnd",gutterSize:"s"},u.a.createElement(g.EuiFlexItem,{grow:!1},u.a.createElement(g.EuiButton,{size:"s",onClick:()=>s(i)},u.a.createElement(p.FormattedMessage,{id:"data.query.queryBar.KQLNestedQuerySyntaxInfoOptOutText",defaultMessage:"Don't show again"}))))))})}}})),r()(this,"increaseLimit",(()=>{this.setState({suggestionLimit:this.state.suggestionLimit+50})})),r()(this,"incrementIndex",(e=>{let t=e+1;(null===e||t>=this.state.suggestions.length)&&(t=0),this.setState({index:t})})),r()(this,"decrementIndex",(e=>{const t=e-1;t<0?this.setState({index:this.state.suggestions.length-1}):this.setState({index:t})})),r()(this,"onSelectLanguage",(e=>{var t;this.services.http.post("/api/kibana/kql_opt_in_stats",{body:JSON.stringify({opt_in:"kuery"===e})});const s=this.props.storageKey;this.services.storage.set(s,e);const i={query:"",language:e};this.onChange(i),this.onSubmit(i),null===(t=this.reportUiCounter)||void 0===t||t.call(this,y.METRIC_TYPE.LOADED,s?`${s}:language:${e}`:`query_string:language:${e}`)})),r()(this,"onOutsideClick",(()=>{this.state.isSuggestionsVisible&&(this.setState({isSuggestionsVisible:!1,index:null}),this.scheduleOnInputBlur())})),r()(this,"blurTimeoutHandle",void 0),r()(this,"scheduleOnInputBlur",(()=>{clearTimeout(this.blurTimeoutHandle),this.blurTimeoutHandle=window.setTimeout((()=>{this.isFocusWithin||this.state.isSuggestionsVisible||this.componentIsUnmounting||(this.handleBlurHeight(),this.props.onChangeQueryInputFocus&&this.props.onChangeQueryInputFocus(!1),this.props.submitOnBlur&&this.onSubmit(this.props.query))}),50)})),r()(this,"onInputBlur",(()=>{Object(d.isFunction)(this.props.onBlur)&&this.props.onBlur()})),r()(this,"onClickSuggestion",((e,t)=>{this.inputRef&&(this.selectSuggestion(e,t),this.inputRef.focus())})),r()(this,"initPersistedLog",(()=>{const{uiSettings:e,storage:t,appName:s}=this.services;this.persistedLog=this.props.persistedLog?this.props.persistedLog:Object(S.o)(e,t,s,this.props.query.language)})),r()(this,"onMouseEnterSuggestion",(e=>{this.setState({index:e})})),r()(this,"textareaId",Object(g.htmlIdGenerator)()()),r()(this,"handleListUpdate",(()=>{var e;if(!this.componentIsUnmounting)return this.setState({queryBarRect:null===(e=this.queryBarInputDivRefInstance.current)||void 0===e?void 0:e.getBoundingClientRect()})})),r()(this,"handleAutoHeight",(()=>{null!==this.inputRef&&document.activeElement===this.inputRef&&(this.inputRef.classList.add("kbnQueryBar__textarea--autoHeight"),this.inputRef.style.setProperty("height",`${this.inputRef.scrollHeight}px`,"important")),this.handleListUpdate()})),r()(this,"handleRemoveHeight",(()=>{null!==this.inputRef&&(this.inputRef.style.removeProperty("height"),this.inputRef.classList.remove("kbnQueryBar__textarea--autoHeight"))})),r()(this,"handleBlurHeight",(()=>{null!==this.inputRef&&(this.handleRemoveHeight(),this.inputRef.scrollTop=0)})),r()(this,"handleOnFocus",(()=>{this.props.onChangeQueryInputFocus&&this.props.onChangeQueryInputFocus(!0),requestAnimationFrame((()=>{this.handleAutoHeight()}))}))}componentDidMount(){const e=Object(S.j)(Object(S.s)(this.props.query.query));Object(d.isEqual)(this.props.query.query,e)||this.onChange({...this.props.query,query:e}),this.initPersistedLog(),this.fetchIndexPatterns(),this.handleListUpdate(),window.addEventListener("resize",this.handleAutoHeight),window.addEventListener("scroll",this.handleListUpdate,{passive:!0,capture:!0})}componentDidUpdate(e){const t=Object(S.j)(Object(S.s)(this.props.query.query));Object(d.isEqual)(this.props.query.query,t)||this.onChange({...this.props.query,query:t}),this.initPersistedLog(),Object(d.isEqual)(e.indexPatterns,this.props.indexPatterns)?Object(d.isEqual)(e.query,this.props.query)||this.updateSuggestions():this.fetchIndexPatterns(),null!==this.state.selectionStart&&null!==this.state.selectionEnd&&(null!=this.inputRef&&this.inputRef.setSelectionRange(this.state.selectionStart,this.state.selectionEnd),this.setState({selectionStart:null,selectionEnd:null}),null!==document.activeElement&&document.activeElement.id===this.textareaId?this.handleAutoHeight():this.handleRemoveHeight())}componentWillUnmount(){this.abortController&&this.abortController.abort(),this.updateSuggestions.cancel&&this.updateSuggestions.cancel(),this.componentIsUnmounting=!0,window.removeEventListener("resize",this.handleAutoHeight),window.removeEventListener("scroll",this.handleListUpdate,{capture:!0})}render(){const e={...this.state.isSuggestionsVisible&&{"aria-controls":"kbnTypeahead__items","aria-owns":"kbnTypeahead__items"},role:"combobox"},t=c()("euiFormControlLayout euiFormControlLayout--group kbnQueryBar__wrap",this.props.className),s=c()("kbnQueryBar__textarea",this.props.iconType?"kbnQueryBar__textarea--withIcon":null,this.props.prepend?"kbnQueryBar__textarea--hasPrepend":null,this.props.disableLanguageSwitcher?null:"kbnQueryBar__textarea--hasAppend"),i=c()("euiFormControlLayout__childrenWrapper kbnQueryBar__textareaWrap",this.props.prepend?"kbnQueryBar__textareaWrap--hasPrepend":null,this.props.disableLanguageSwitcher?null:"kbnQueryBar__textareaWrap--hasAppend");return u.a.createElement("div",{className:t,onFocus:e=>{this.isFocusWithin=!0},onBlur:e=>{this.isFocusWithin=!1,this.scheduleOnInputBlur()}},this.props.prepend,u.a.createElement(g.EuiOutsideClickDetector,{onOutsideClick:this.onOutsideClick},u.a.createElement("div",n()({},e,{style:{position:"relative",width:"100%"},"aria-label":l.i18n.translate("data.query.queryBar.comboboxAriaLabel",{defaultMessage:"Search and filter the {pageType} page",values:{pageType:this.services.appName}}),"aria-haspopup":"true","aria-expanded":this.state.isSuggestionsVisible,"data-skip-axe":"aria-required-children"}),u.a.createElement("div",{role:"search",className:i,ref:this.queryBarInputDivRefInstance},u.a.createElement(g.EuiTextArea,{placeholder:this.props.placeholder||l.i18n.translate("data.query.queryBar.searchInputPlaceholder",{defaultMessage:"Search"}),value:this.forwardNewValueIfNeeded(this.getQueryString()),onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onChange:this.onInputChange,onClick:this.onClickInput,onBlur:this.onInputBlur,onFocus:this.handleOnFocus,className:s,fullWidth:!0,rows:1,id:this.textareaId,autoFocus:!this.props.onChangeQueryInputFocus&&!this.props.disableAutoFocus,inputRef:e=>{e&&(this.inputRef=e)},autoComplete:"off",spellCheck:!1,"aria-label":l.i18n.translate("data.query.queryBar.searchInputAriaLabel",{defaultMessage:"Start typing to search and filter the {pageType} page",values:{pageType:this.services.appName}}),"aria-autocomplete":"list","aria-controls":this.state.isSuggestionsVisible?"kbnTypeahead__items":void 0,"aria-activedescendant":this.state.isSuggestionsVisible&&"number"==typeof this.state.index?`suggestion-${this.state.index}`:void 0,role:"textbox","data-test-subj":this.props.dataTestSubj||"queryInput",isInvalid:this.props.isInvalid},this.forwardNewValueIfNeeded(this.getQueryString())),this.props.iconType?u.a.createElement("div",{className:"euiFormControlLayoutIcons"},u.a.createElement(g.EuiIcon,{className:"euiFormControlLayoutCustomIcon__icon","aria-hidden":"true",type:this.props.iconType})):null,this.props.isClearable&&this.props.query.query?u.a.createElement("div",{className:"euiFormControlLayoutIcons euiFormControlLayoutIcons--right"},u.a.createElement("button",{type:"button",className:"euiFormControlLayoutClearButton",title:l.i18n.translate("data.query.queryBar.clearInputLabel",{defaultMessage:"Clear input"}),onClick:()=>{this.onQueryStringChange(""),this.props.autoSubmit&&this.onSubmit({query:"",language:this.props.query.language})}},u.a.createElement(g.EuiIcon,{className:"euiFormControlLayoutClearButton__icon",type:"cross"}))):null),u.a.createElement(g.EuiPortal,null,u.a.createElement(E.e,{show:this.state.isSuggestionsVisible,suggestions:this.state.suggestions.slice(0,this.state.suggestionLimit),index:this.state.index,onClick:this.onClickSuggestion,onMouseEnter:this.onMouseEnterSuggestion,loadMore:this.increaseLimit,queryBarRect:this.state.queryBarRect,size:this.props.size})))),this.props.disableLanguageSwitcher?null:u.a.createElement(f,{language:this.props.query.language,anchorPosition:this.props.languageSwitcherPopoverAnchorPosition,onSelectLanguage:this.onSelectLanguage,nonKqlMode:this.props.nonKqlMode,nonKqlModeHelpText:this.props.nonKqlModeHelpText}))}formatTextAreaValue(e){return e.replace(/\u00A0/g," ")}forwardNewValueIfNeeded(e){var t,s;const i=null!==(t=null===(s=this.inputRef)||void 0===s?void 0:s.value)&&void 0!==t?t:"",n=this.formatTextAreaValue(e);return n===this.formatTextAreaValue(i)?i:n}}r()(query_string_input_QueryStringInputUI,"defaultProps",{storageKey:q.KIBANA_USER_QUERY_LANGUAGE_KEY})}}]);